#@ load("@ytt:data", "data")
#@ load("helpers.star", "ci_image", "skip_ci_condition")

#@ def gcs_path():
#@   c = ['monorepo_github_actions_conclusions']
#@   c.append('${{ github.sha }}')
#@   c.append('${{ github.workflow }}')
#@   return '/'.join(c)
#@ end

#@ def finish_jobs(prepare_jobs_names):
finish:
  name: finish
  needs: #@ prepare_jobs_names + [dep.name for dep in data.values.deps if not getattr(dep, "skip_tests", False)]
  runs-on: ubuntu-18.04
  if: #@ skip_ci_condition()
  #@yaml/text-templated-strings
  steps:
    - uses: technote-space/workflow-conclusion-action@v1
    - uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
      with:
        service_account_key: ${{ secrets.GCR_JSON_KEY }}
        export_default_credentials: true
    - name: RECORD BUILD FINISH
      run: |
        echo -n "${{ env.WORKFLOW_CONCLUSION }}" > conclusion

        gsutil cp conclusion \
          'gs://(@= gcs_path() @)'

        gcloud auth configure-docker
        docker pull (@= ci_image() @)
        docker run \
          --env GITHUB_RUN_ID=${{ github.run_id }} \
          --env BUILDEVENT_APIKEY=${{ secrets.HONEYCOMB_API_KEY }} \
          --env BUILD_START=${{ needs.prepare.outputs.build_start }} \
          --env BUILD_RESULT=${{ env.WORKFLOW_CONCLUSION }} \
          (@= ci_image() @) \
          ci/scripts/finish.sh
#@ end
